OUT_ZIP=LinuxConsole.zip
LNCR_EXE=LinuxConsole.exe

DLR=wget
LAUNCHER_URL=https://github.com/yuk7/wsldl/releases/download/20040300/Launcher.exe
BASE_URL=http://dl-cdn.alpinelinux.org/alpine/v3.11/releases/x86_64/alpine-minirootfs-3.11.5-x86_64.tar.gz
LNCR_ZIP_URL=https://github.com/yuk7/wsldl/releases/download/20040300/icons.zip
LNCR_ZIP_EXE=LinuxConsole.exe

all: $(OUT_ZIP)

zip: $(OUT_ZIP)
$(OUT_ZIP): ziproot
	@echo -e '\e[1;31mBuilding $(OUT_ZIP)\e[m'
	cd ziproot; bsdtar -a -cf ../$(OUT_ZIP) *

ziproot: Launcher.exe rootfs.tar.gz
	@echo -e '\e[1;31mBuilding ziproot...\e[m'
	mkdir ziproot
	cp Launcher.exe ziproot/${LNCR_EXE}
	cp rootfs.tar.gz ziproot/

exe: Launcher.exe
Launcher.exe: 
	@echo -e '\e[1;31mDownloading Launcher.exe...\e[m'
	$(DLR) $(LAUNCHER_URL) 

rootfs.tar.gz: rootfs
	@echo -e '\e[1;31mBuilding rootfs.tar.gz...\e[m'
	cd rootfs;  tar -zcpf ../rootfs.tar.gz ` ls`
	 chown `id -un` rootfs.tar.gz

rootfs: base.tar.gz profile
	@echo -e '\e[1;31mBuilding rootfs...\e[m'
	mkdir rootfs
	 tar -zxpf base.tar.gz -C rootfs
	 cp -f /etc/resolv.conf rootfs/etc/resolv.conf
	 cp -f profile rootfs/etc/profile
	 chroot rootfs /sbin/apk update
	 chroot rootfs /sbin/apk add bash
	echo "# This file was automatically generated by WSL. To stop automatic generation of this file, remove this line." |  tee rootfs/etc/resolv.conf
	 rm -rf ` find rootfs/var/cache/apk/ -type f`
	 chmod +x rootfs

base.tar.gz:
	@echo -e '\e[1;31mDownloading base.tar.gz...\e[m'
	$(DLR) $(DLR_FLAGS) $(BASE_URL) -o base.tar.gz

clean:
	@echo -e '\e[1;31mCleaning files...\e[m'
	-rm ${OUT_ZIP}
	-rm -r ziproot
	-rm Launcher.exe
	-rm icons.zip
	-rm rootfs.tar.gz
	- rm -r rootfs
	-rm base.tar.gz
